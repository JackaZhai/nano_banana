<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MatchAi 控制台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar__brand">
        <div class="logo" aria-hidden="true">🤖</div>
        <div>
          <p class="eyebrow">MatchAi</p>
          <h1>控制台</h1>
        </div>
      </div>
      <nav class="nav">
        <a class="nav__item active" href="#">仪表盘</a>
        <a class="nav__item" href="#">大模型</a>
        <a class="nav__item" href="#">图像生成</a>
        <a class="nav__item" href="#">日志</a>
        <a class="nav__item" href="#">Api key 管理</a>
      </nav>
    </aside>
    <div class="page">
      <header class="header">
        <div>
          <p class="eyebrow">MatchAi</p>
          <h1>控制台工作台</h1>
          <p class="muted">通过右侧选项选择需要的功能，界面更清爽。</p>
        </div>
        <div class="header__aside">
          <div class="switcher" role="tablist" aria-label="功能选择">
            <p class="mini-label">选择功能</p>
            <div class="switcher__pills">
              <button class="pill active" data-feature="draw" aria-selected="true">图像生成</button>
              <button class="pill" data-feature="keys" aria-selected="false">Api key 管理</button>
              <button class="pill" data-feature="chat" aria-selected="false">大模型对话</button>
            </div>
          </div>
          <div class="endpoint" data-feature-display="draw">
            <p class="mini-label">接口地址</p>
            <code>{{ api_host }}/v1/draw/nano-banana</code>
          </div>
          <div class="endpoint" data-feature-display="keys" hidden>
            <p class="mini-label">作用范围</p>
            <code>为图像生成与对话接口配置密钥</code>
          </div>
          <div class="endpoint" data-feature-display="chat" hidden>
            <p class="mini-label">接口地址</p>
            <code>{{ api_host }}/v1/chat/completions</code>
          </div>
        </div>
      </header>

      {% if not has_api_key %}
      <div class="notice notice--warning" id="apiKeyNotice">
        未检测到 <code>NANO_BANANA_API_KEY</code> 环境变量，请在服务器上设置后再提交任务。
      </div>
      {% endif %}

      <div class="feature-section active" id="feature-draw">
        <main class="grid">
          <section class="panel">
          <div class="panel__header">
            <div>
              <p class="eyebrow">生成参数</p>
              <h2>填写提示词并提交</h2>
            </div>
            <button class="ghost" id="resetBtn" type="button">重置</button>
          </div>

          <form id="drawForm" class="form">
            <label class="form-field">
              <span>提示词 <strong>*</strong></span>
              <textarea id="prompt" name="prompt" rows="3" placeholder="一只科幻机械猫站在霓虹城市中央，蓝紫色光影，超写实"></textarea>
            </label>

            <div class="field-row">
              <label class="form-field">
                <span>模型</span>
                <select id="model" name="model">
                  <option value="nano-banana-fast">nano-banana-fast（极速）</option>
                  <option value="nano-banana">nano-banana（标准）</option>
                  <option value="nano-banana-pro">nano-banana-pro（高质）</option>
                </select>
              </label>
              <label class="form-field">
                <span>画面比例</span>
                <select id="aspectRatio" name="aspectRatio">
                  <option value="auto">auto</option>
                  <option value="1:1">1:1</option>
                  <option value="16:9">16:9</option>
                  <option value="9:16">9:16</option>
                  <option value="4:3">4:3</option>
                  <option value="3:4">3:4</option>
                  <option value="3:2">3:2</option>
                  <option value="2:3">2:3</option>
                  <option value="5:4">5:4</option>
                  <option value="4:5">4:5</option>
                  <option value="21:9">21:9</option>
                </select>
              </label>
              <label class="form-field">
                <span>分辨率（Pro 可用）</span>
                <select id="imageSize" name="imageSize">
                  <option value="">默认 1K</option>
                  <option value="1K">1K</option>
                  <option value="2K">2K</option>
                  <option value="4K">4K</option>
                </select>
              </label>
            </div>

            <div class="dropzone" id="dropzone">
              <input id="fileInput" type="file" accept="image/*" multiple aria-label="上传参考图">
              <div class="dropzone__text">
                <p class="eyebrow">参考图</p>
                <h3>拖拽或点击上传图片</h3>
                <p class="muted">支持多张图片，上传后将随请求一并发送。</p>
              </div>
              <div id="fileList" class="thumbs"></div>
            </div>

            <div class="field-row">
              <label class="form-field">
                <span>Webhook（留空自动轮询 result）</span>
                <input id="webHook" name="webHook" type="url" placeholder="https://your-webhook-url.com/callback">
              </label>
              <label class="form-checkbox">
                <input type="checkbox" id="shutProgress" name="shutProgress">
                <span>关闭进度回复（直接返回最终结果）</span>
              </label>
            </div>

            <div class="actions">
              <button class="primary" type="submit" id="submitBtn">立即生成</button>
              <p class="hint">确保环境变量 <code>NANO_BANANA_API_KEY</code> 已设置。</p>
            </div>
          </form>
        </section>

          <div class="stacked">
            <section class="panel" id="statusPanel">
              <div class="panel__header">
                <div>
                  <p class="eyebrow">生成进度</p>
                  <h2>实时跟踪</h2>
                </div>
                <span class="status-pill" id="statusText">尚未开始</span>
              </div>
              <div class="progress">
                <div id="progressBar" class="progress__bar" style="width: 0%"></div>
              </div>
              <pre class="log" id="log"></pre>
            </section>

            <section class="panel" id="resultPanel">
              <div class="panel__header">
                <div>
                  <p class="eyebrow">生成结果</p>
                  <h2>图片与响应</h2>
                </div>
                <button class="ghost" id="copyImage" type="button">复制图片</button>
              </div>
              <div id="gallery" class="gallery empty">
                <p class="placeholder">结果将展示在这里。</p>
              </div>
            </section>
          </div>
        </main>
      </div>

      <section class="panel feature-section" id="feature-keys" hidden>
        <div class="panel__header">
          <div>
            <p class="eyebrow">安全</p>
            <h2>Api key 管理</h2>
            <p class="muted">添加、删除或切换当前使用的 Api key，供图像生成与大模型对话共用。</p>
          </div>
        </div>

        <form id="apiKeyForm" class="key-form">
          <label class="form-field">
            <span>新增 Api key</span>
            <input id="apiKeyInput" name="apiKey" type="text" placeholder="请输入以 sk- 开头的密钥" autocomplete="off">
          </label>
          <div class="actions">
            <button class="primary" type="submit">添加并使用</button>
            <p class="hint">当前使用：<code id="activeKeyMask">暂无</code></p>
          </div>
        </form>

        <div class="key-list" id="apiKeyList">
          <p class="placeholder">尚未添加 Api key，添加后可在此切换或删除。</p>
        </div>
      </section>

      <section class="panel chat feature-section" id="feature-chat" hidden>
        <div class="panel__header">
          <div>
            <p class="eyebrow">大模型</p>
            <h2>对话调试台</h2>
            <p class="muted">接口与 OpenAI Chat Completions 兼容，直接提交消息即可。</p>
          </div>
        </div>

        <form id="chatForm" class="chat__form">
          <div class="chat__controls">
            <label class="form-field">
              <span>模型</span>
              <select id="chatModel" name="chatModel">
                <option value="nano-banana-fast">nano-banana-fast</option>
                <option value="nano-banana">nano-banana</option>
                <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
                <option value="gpt-4o-all">gpt-4o-all</option>
                <option value="o4-mini-all">o4-mini-all</option>
                <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
              </select>
            </label>

            <label class="form-field">
              <span>System Prompt</span>
              <input id="systemPrompt" name="systemPrompt" type="text" placeholder="You are a helpful assistant.">
            </label>

            <label class="form-checkbox">
              <input type="checkbox" id="chatStream" name="chatStream">
              <span>启用流式</span>
            </label>
          </div>

          <label class="form-field chat__input">
            <span>提问</span>
            <textarea id="chatMessage" name="chatMessage" rows="3" placeholder="请输入要咨询的大模型问题"></textarea>
          </label>

          <div class="chat__actions">
            <button type="submit" class="primary" id="chatSend">发送</button>
            <button type="button" class="ghost" id="chatClear">清空记录</button>
          </div>
        </form>

        <div class="chat__log" id="chatLog">
          <div class="chat__empty">尚无对话，输入内容开始与模型交流。</div>
        </div>
      </section>
    </div>
  </div>
  <script>window.__API_HOST__ = "{{ api_host }}";</script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
